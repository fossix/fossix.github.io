<!doctype html><html><head>
<link rel=stylesheet href=/syntax.css>
<link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css integrity=sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO crossorigin=anonymous>
<link href=/fossix.css rel=stylesheet media=screen>
<title>
Fossix - Intro To Assembly Programming From A Dummy
</title>
<script data-ad-client=ca-pub-0086577717613608 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8>
</head>
<body><nav class="navbar navbar-expand-md navbar-dark bg-dark">
<a class=navbar-brand href=/>
<img src=/site-logo.png width=40 height=45 class="d-inline-block align-top" alt>
<span class=front-site-title>Fossix</span>
</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class=nav-item>
<a href=/categories/snippets class=nav-link>
Snippets
</a>
</li>
<li class=nav-item>
<a href=/categories/blogs class=nav-link>
Blogs
</a>
</li>
<li class=nav-item>
<a href=/categories/articles class=nav-link>
Articles
</a>
</li>
<li class=nav-item>
<a class=nav-link href=/archive/>
Archive
</a>
</li>
</ul>
</div>
</nav>
<div class=container-fluid style=margin-top:25px>
<div class=row>
<div class=col-lg-3>
</div>
<div class="col-lg-6 content">
<h1>Intro To Assembly Programming From A Dummy</h1>
<div class=alert-light>
<div class=float-left>
<span class=badge>
29 March, 2017 | santosh
</span>
</div>
<div class=float-right>
<a href=https://fossix.org/tags/c class="badge badge-light">#c</a>
<a href=https://fossix.org/tags/asm class="badge badge-light">#asm</a>
</div>
<span class=badge> </span>
</div>
<p>We are all comfortable writing code in high level languages like C, and some
would even argue C is not a high level language like Java, or Python etc. But
the truth is the more you go closer to the silicon, the more speed you get,
trading away the traits of high level design (readability, maintainability
etc). Here is an example of this.</p>
<p>Long long ago, so long ago, I was seeing so many executable programs in my <code>~/bin</code>
directory, disturbing the auto-completion in the CLI. I was so lazy to manually
delete it, and Makefiles are no use for simple test codes that I write
randomly. So I took a bold step of writing a script which would delete any ELF
files. The script went like this:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/bash
</span><span class=cp></span>
<span class=k>for</span> i in *<span class=p>;</span> <span class=k>do</span>
    <span class=k>if</span> <span class=o>[</span> -f <span class=s2>&#34;</span><span class=nv>$i</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=k>if</span> file <span class=s2>&#34;</span><span class=nv>$i</span><span class=s2>&#34;</span> <span class=p>|</span> grep ELF &gt; /dev/null <span class=p>;</span> <span class=k>then</span>
            rm <span class=s2>&#34;</span><span class=nv>$i</span><span class=s2>&#34;</span><span class=p>;</span>
        <span class=k>fi</span>
    <span class=k>fi</span>
<span class=k>done</span>
</code></pre></div><p>Here I could have checked for executable mode of a file, but I don’t want shell
scripts lying around to get removed too. Now, back to the story - Later one day,
this script took about 2 seconds to loop through and delete all ELFs. For a busy
guy like me (you got to believe me ;-)), this was infinity.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span><span class=nb>time</span> ../sh/rmelf
<span class=go>real    0m1.273s
</span><span class=go>user    0m0.405s
</span><span class=go>sys 0m1.028s
</span></code></pre></div><p>Then the brave guy (that’s me), took another brave decision of writing it in C,
for which the code goes like this:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cm>/* rmelf.c
</span><span class=cm> * Remove executables (ELF) in a directory.
</span><span class=cm> *
</span><span class=cm> * Copyright (C) 2007 - 2010 Santosh Sivaraj (santoshs (_at_) fossix.org)
</span><span class=cm> *
</span><span class=cm> * This program is free software; you can redistribute it and/or
</span><span class=cm> * modify it under the terms of the GNU General Public License as
</span><span class=cm> * published by the Free Software Foundation, version 2 of the
</span><span class=cm> * License.
</span><span class=cm> */</span>

<span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;dirent.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;malloc.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=cp>#define FIRST_FOUR_BYTES 4
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span> <span class=p>(</span><span class=kt>int</span> <span class=n>argv</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argc</span><span class=p>[])</span>
<span class=p>{</span>
        <span class=k>struct</span> <span class=n>dirent</span> <span class=o>*</span><span class=n>ent</span><span class=p>,</span> <span class=o>*</span><span class=n>rent</span><span class=p>;</span>
        <span class=k>struct</span> <span class=n>stat</span> <span class=n>stat_buf</span><span class=p>;</span>
        <span class=n>DIR</span> <span class=o>*</span><span class=n>dir</span><span class=p>;</span>
        <span class=kt>int</span> <span class=n>result</span><span class=p>,</span> <span class=n>stat_res</span><span class=p>,</span> <span class=n>fd</span><span class=p>;</span>
        <span class=kt>char</span> <span class=n>file_start</span><span class=p>[</span><span class=mi>5</span><span class=p>];</span>

        <span class=n>dir</span> <span class=o>=</span> <span class=n>opendir</span><span class=p>(</span><span class=s>&#34;.&#34;</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>dir</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>perror</span><span class=p>(</span><span class=n>argc</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=n>ent</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>dirent</span> <span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>dirent</span><span class=p>));</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>ent</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>fprintf</span><span class=p>(</span><span class=n>stdout</span><span class=p>,</span> <span class=s>&#34;Cannot allocate memory for dirent</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
                        <span class=n>strlen</span><span class=p>(</span><span class=s>&#34;Cannot allocate memory for dirent</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>));</span>
                <span class=n>closedir</span><span class=p>(</span><span class=n>dir</span><span class=p>);</span>
                <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=n>result</span> <span class=o>=</span> <span class=n>readdir_r</span><span class=p>(</span><span class=n>dir</span><span class=p>,</span> <span class=n>ent</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rent</span><span class=p>);</span>
        <span class=k>while</span> <span class=p>(</span><span class=n>rent</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>result</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>stat_res</span> <span class=o>=</span> <span class=n>stat</span><span class=p>(</span><span class=n>rent</span><span class=o>-&gt;</span><span class=n>d_name</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>stat_buf</span><span class=p>);</span>
                <span class=k>if</span><span class=p>(</span><span class=n>stat_res</span><span class=p>)</span> <span class=p>{</span>
                        <span class=n>result</span> <span class=o>=</span> <span class=n>readdir_r</span><span class=p>(</span><span class=n>dir</span><span class=p>,</span> <span class=n>ent</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rent</span><span class=p>);</span>
                        <span class=k>continue</span><span class=p>;</span>
                <span class=p>}</span>

                <span class=k>if</span> <span class=p>(</span><span class=n>stat_buf</span><span class=p>.</span><span class=n>st_mode</span> <span class=o>&amp;</span> <span class=n>S_IFREG</span><span class=p>)</span> <span class=p>{</span>
                        <span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=n>rent</span><span class=o>-&gt;</span><span class=n>d_name</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
                        <span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>file_start</span><span class=p>,</span> <span class=n>FIRST_FOUR_BYTES</span><span class=p>);</span>
                        <span class=cm>/* fprintf(stdout, file_start, FIRST_FOUR_BYTES); */</span>
                        <span class=k>if</span><span class=p>(</span><span class=n>strncmp</span><span class=p>(</span><span class=n>file_start</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;ELF&#34;</span><span class=p>,</span> <span class=n>FIRST_FOUR_BYTES</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>==</span>
                           <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                                <span class=n>unlink</span><span class=p>(</span><span class=n>rent</span><span class=o>-&gt;</span><span class=n>d_name</span><span class=p>);</span>
                        <span class=p>}</span>
                        <span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
                <span class=p>}</span>
                <span class=n>result</span> <span class=o>=</span> <span class=n>readdir_r</span><span class=p>(</span><span class=n>dir</span><span class=p>,</span> <span class=n>ent</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rent</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>result</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;Error&#34;</span><span class=p>,</span> <span class=n>strlen</span><span class=p>(</span><span class=s>&#34;Error&#34;</span><span class=p>));</span>
        <span class=p>}</span>
        <span class=n>free</span><span class=p>(</span><span class=n>ent</span><span class=p>);</span>
        <span class=n>closedir</span><span class=p>(</span><span class=n>dir</span><span class=p>);</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>I know, that is a comment-less code, bad code, could have been better, but it
solved the purpose, so kept it safe. Now, for the same number of files and ELFs,
the time this baby takes is:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span><span class=nb>time</span> rmelf 
<span class=go>real    0m0.008s
</span><span class=go>user    0m0.000s
</span><span class=go>sys     0m0.008s
</span></code></pre></div><p>Impressive isn’t it ;-)</p>
<p>Ok, the point is moving down the language hierarchy, moving towards the low
levels, always guarantees speed. But stability, manageability and readability
(Your son may maintain it in the future!) are guaranteed to be non-existent. But
there are systems requiring raw power and speed, in case of most embedded
systems. So you might want to learn to code your toys.</p>
<p>A small intro on Assembly in Linux</p>
<p>Linux is a protected mode, 32 bit OS. So there are no segment registers, segment
registers and paging are already set up.</p>
<h3 id=segments>Segments</h3>
<p>Don’t confuse with segment registers. The segment here is a section in a program.</p>
<pre tabindex=0><code>section .text   ;Code segment
section .data   ;Data segment
section .bss    ;uninitialized data
</code></pre><h3 id=program-start>Program start</h3>
<p>We have to specify where our main program starts or else we would get a linker
error. We tell the linker how we have indicated the main section by using</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=nf>global</span> <span class=no>_start</span>   <span class=c>;main() as in C
</span><span class=c></span>    <span class=c>; _start and main are customary, but can be any name
</span></code></pre></div><p>Then we start the main section using a label</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=nl>_start:</span>
            <span class=c>;program starts executing from here.
</span></code></pre></div><p>All arguments to the program (<code>argv[][]</code>) are put into the top of the stack at
program execution, so to obtain them we just pop out into a location.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm>    <span class=nf>pop</span> <span class=no>ebx</span>     <span class=c>;the number of arguments(argc)
</span><span class=c></span>    <span class=no>pop</span> <span class=no>ebx</span>     <span class=c>;the program name(argv[0])
</span><span class=c></span>    <span class=no>pop</span> <span class=no>ebx</span>     <span class=c>;the actual arguments start here
</span></code></pre></div><h3 id=system-call>System call</h3>
<p>We use Linux system calls for various functions like printing. To get the kernel
attention to do some work we issue an interrupt with interrupt number <code>80h</code>.</p>
<p>The arguments to system a call are placed in <code>ebx</code>, <code>ecx</code>, <code>edx</code>, <code>esi</code>, <code>edi</code>,
<code>ebp</code>. If there are more than six, ebx contains the location of the argument
list. System calls are declared in <code>unistd.h</code>, and help in section 2 of man page.</p>
<p>Some frequently used system call numbers:</p>
<pre tabindex=0><code>    exit        1
    read        3
    write       4
    creat       8
    sys_close   6
</code></pre><p>Function arguments are pushed from last to first into the stack.</p>
<p>Some useful ASCII codes:</p>
<pre tabindex=0><code>    \n  10
    \r  13
</code></pre><p>Labels are used for branching and useful to be used as functions. Looping labels
have a dot preceding them.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=na>.loop</span>   <span class=no>dec</span> <span class=no>ax</span>
    <span class=c>;; other statements
</span><span class=c></span>    <span class=nf>jnz</span> <span class=no>.loop</span>
</code></pre></div><p>For a detailed Assembly language tutorial, see Linux Assembly Tutorial,
step-by-step guide.</p>
</div>
<div class=col-lg-3>
<div>
<h5>You might also like</h5>
<ul style=list-style-type:none>
<li class=box-list><a href=/articles/generate-unique-ids/ class=item>Generate unique IDs</a></li>
<li class=box-list><a href=/articles/program-compilation-an-introduction/ class=item>Program Compilation - An introduction</a></li>
<li class=box-list><a href=/articles/the-birth-of-a-process/ class=item>The Birth of a Process</a></li>
</ul>
</div>
</div><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<script src=/fossix.js></script>
<script src=//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<hr>
<div class=container>
<div class=row>
<div class=mx-auto>
<ul class=nav>
<li class=nav-item>
<a class="nav-link text-muted" href=/about>About</a>
</li>
<li class=nav-item>
<a class="nav-link text-muted" href=/contact/>Contact</a>
</li>
<li class=nav-item>
<a class="nav-link text-muted" href=/privacy/>Privacy Policy</a>
</li>
</ul>
</div>
</div>
<div class=row>
<div class=mx-auto>
<p>Site design and logo and content &copy; fossix.org</p>
</div>
</div>
</div>
</div>
</div>
</body>
</html>