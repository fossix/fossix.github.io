<!doctype html><html><head>
<link rel=stylesheet href=/syntax.css>
<link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css integrity=sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO crossorigin=anonymous>
<link href=/fossix.css rel=stylesheet media=screen>
<title>
Fossix - Intro To Assembly Programming From A Dummy
</title>
<script data-ad-client=ca-pub-0086577717613608 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8>
</head>
<body><nav class="navbar navbar-expand-lg navbar-dark bg-dark">
<a class=navbar-brand href=/>
<img src=/site-logo.png width=40 height=45 class="d-inline-block align-top" alt>
</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class="nav-item active">
<a class=nav-link href=/>Fossix
<span class=sr-only>(current)</span>
</a>
</li>
</ul>
<form class="form-inline my-2 my-lg-0" id=search>
<input class="form-control mr-sm-2" type=search placeholder=Search aria-label=Search id=searchString name=searchString>
<button class="btn btn-outline-success my-2 my-sm-0" type=submit name=googleSearchName value=Search>Search</button>
</form>
</div>
</nav>
<div class=container-fluid style=margin-top:25px>
<div class=row>
<div class=col-md-2>
<div class="list-group list-group-flush">
<a href=/ class="list-group-item list-group-item-action">
Home
</a>
<a href=/categories/snippets class="list-group-item list-group-item-action">
Snippets
</a>
<a href=/categories/blogs class="list-group-item list-group-item-action">
Blogs
</a>
<a href=/categories/articles class="list-group-item list-group-item-action">
Articles
</a>
<a href=/archive/ class="list-group-item list-group-item-action">
Archive
</a>
</div>
</div>
<div class=col-md-6>
<div class="row content-title">
<h1>Intro To Assembly Programming From A Dummy</h1>
</div>
<div class="alert alert-light">
<span class=badge>Posted on: 29 March, 2017</span>
<div class=float-right>
<span> By santosh</span>
</div>
</div>
<hr>
<p>We are all comfortable writing code in high level languages like C, and some
would even argue C is not a high level language like Java, or Python etc. But
the truth is the more you go closer to the silicon, the more speed you get,
trading away the traits of high level design (readability, maintainability
etc). Here is an example of this.</p>
<p>Long long ago, so long ago, I was seeing so many executable programs in my <code>~/bin</code>
directory, disturbing the auto-completion in the CLI. I was so lazy to manually
delete it, and Makefiles are no use for simple test codes that I write
randomly. So I took a bold step of writing a script which would delete any ELF
files. The script went like this:</p>
<pre><code class=language-bash>#!/bin/bash

for i in *; do
    if [ -f &quot;$i&quot; ]; then
        if file &quot;$i&quot; | grep ELF &gt; /dev/null ; then
            rm &quot;$i&quot;;
        fi
    fi
done
</code></pre>
<p>Here I could have checked for executable mode of a file, but I don’t want shell
scripts lying around to get removed too. Now, back to the story - Later one day,
this script took about 2 seconds to loop through and delete all ELFs. For a busy
guy like me (you got to believe me ;-)), this was infinity.</p>
<pre><code class=language-console>$ time ../sh/rmelf
real    0m1.273s
user    0m0.405s
sys 0m1.028s
</code></pre>
<p>Then the brave guy (that’s me), took another brave decision of writing it in C,
for which the code goes like this:</p>
<pre><code class=language-c>/* rmelf.c
 * Remove executables (ELF) in a directory.
 *
 * Copyright (C) 2007 - 2010 Santosh Sivaraj (santoshs (_at_) fossix.org)
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation, version 2 of the
 * License.
 */

#include &lt;stdio.h&gt;
#include &lt;dirent.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;malloc.h&gt;
#include &lt;string.h&gt;
#include &lt;fcntl.h&gt;

#define FIRST_FOUR_BYTES 4

int main (int argv, char *argc[])
{
        struct dirent *ent, *rent;
        struct stat stat_buf;
        DIR *dir;
        int result, stat_res, fd;
        char file_start[5];

        dir = opendir(&quot;.&quot;);
        if (!dir) {
                perror(argc[0]);
                return 0;
        }

        ent = (struct dirent *)malloc(sizeof(struct dirent));
        if (!ent) {
                fprintf(stdout, &quot;Cannot allocate memory for dirent\n&quot;,
                        strlen(&quot;Cannot allocate memory for dirent\n&quot;));
                closedir(dir);
                return 0;
        }

        result = readdir_r(dir, ent, &amp;rent);
        while (rent &amp;&amp; !result) {
                stat_res = stat(rent-&gt;d_name, &amp;stat_buf);
                if(stat_res) {
                        result = readdir_r(dir, ent, &amp;rent);
                        continue;
                }

                if (stat_buf.st_mode &amp; S_IFREG) {
                        fd = open(rent-&gt;d_name, O_RDONLY);
                        read(fd, file_start, FIRST_FOUR_BYTES);
                        /* fprintf(stdout, file_start, FIRST_FOUR_BYTES); */
                        if(strncmp(file_start+1, &quot;ELF&quot;, FIRST_FOUR_BYTES-1) ==
                           0) {
                                unlink(rent-&gt;d_name);
                        }
                        close(fd);
                }
                result = readdir_r(dir, ent, &amp;rent);
        }
        if (result) {
                fprintf(stderr, &quot;Error&quot;, strlen(&quot;Error&quot;));
        }
        free(ent);
        closedir(dir);
        return 0;
}
</code></pre>
<p>I know, that is a comment-less code, bad code, could have been better, but it
solved the purpose, so kept it safe. Now, for the same number of files and ELFs,
the time this baby takes is:</p>
<pre><code class=language-console>$ time rmelf 
real    0m0.008s
user    0m0.000s
sys     0m0.008s
</code></pre>
<p>Impressive isn’t it ;-)</p>
<p>Ok, the point is moving down the language hierarchy, moving towards the low
levels, always guarantees speed. But stability, manageability and readability
(Your son may maintain it in the future!) are guaranteed to be non-existent. But
there are systems requiring raw power and speed, in case of most embedded
systems. So you might want to learn to code your toys.</p>
<p>A small intro on Assembly in Linux</p>
<p>Linux is a protected mode, 32 bit OS. So there are no segment registers, segment
registers and paging are already set up.</p>
<h3 id=segments>Segments</h3>
<p>Don’t confuse with segment registers. The segment here is a section in a program.</p>
<pre><code>section .text   ;Code segment
section .data   ;Data segment
section .bss    ;uninitialized data
</code></pre>
<h3 id=program-start>Program start</h3>
<p>We have to specify where our main program starts or else we would get a linker
error. We tell the linker how we have indicated the main section by using</p>
<pre><code class=language-asm>global _start   ;main() as in C
    ; _start and main are customary, but can be any name
</code></pre>
<p>Then we start the main section using a label</p>
<pre><code class=language-asm>_start:
            ;program starts executing from here.
</code></pre>
<p>All arguments to the program (<code>argv[][]</code>) are put into the top of the stack at
program execution, so to obtain them we just pop out into a location.</p>
<pre><code class=language-asm>    pop ebx     ;the number of arguments(argc)
    pop ebx     ;the program name(argv[0])
    pop ebx     ;the actual arguments start here
</code></pre>
<h3 id=system-call>System call</h3>
<p>We use Linux system calls for various functions like printing. To get the kernel
attention to do some work we issue an interrupt with interrupt number <code>80h</code>.</p>
<p>The arguments to system a call are placed in <code>ebx</code>, <code>ecx</code>, <code>edx</code>, <code>esi</code>, <code>edi</code>,
<code>ebp</code>. If there are more than six, ebx contains the location of the argument
list. System calls are declared in <code>unistd.h</code>, and help in section 2 of man page.</p>
<p>Some frequently used system call numbers:</p>
<pre><code>    exit        1
    read        3
    write       4
    creat       8
    sys_close   6
</code></pre>
<p>Function arguments are pushed from last to first into the stack.</p>
<p>Some useful ASCII codes:</p>
<pre><code>    \n  10
    \r  13
</code></pre>
<p>Labels are used for branching and useful to be used as functions. Looping labels
have a dot preceding them.</p>
<pre><code class=language-asm>.loop   dec ax
    ;; other statements
    jnz .loop
</code></pre>
<p>For a detailed Assembly language tutorial, see Linux Assembly Tutorial,
step-by-step guide.</p>
<hr>
<div class=float-right>
<a href=https://fossix.org/tagsc class="badge badge-dark">c</a>
<a href=https://fossix.org/tagsasm class="badge badge-dark">asm</a>
</div>
</div><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<script src=/fossix.js></script>
<script src=//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<hr>
<div class=container>
<div class=row>
<div class=mx-auto>
<ul class=nav>
<li class=nav-item>
<a class="nav-link text-muted" href=/about>About</a>
</li>
<li class=nav-item>
<a class="nav-link text-muted" href=/contact/>Contact</a>
</li>
<li class=nav-item>
<a class="nav-link text-muted" href=/privacy/>Privacy Policy</a>
</li>
</ul>
</div>
</div>
<div class=row>
<div class=mx-auto>
<p>Site design and logo and content &copy; fossix.org</p>
</div>
</div>
</div>
</div>
</div>
</body>
</html>