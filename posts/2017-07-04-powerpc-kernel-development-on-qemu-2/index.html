<!doctype html><html><head>
<link rel=stylesheet href=/syntax.css>
<link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css integrity=sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO crossorigin=anonymous>
<link href=/fossix.css rel=stylesheet media=screen>
<title>
Fossix - More kernel development using qemu
</title>
<script data-ad-client=ca-pub-0086577717613608 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8>
</head>
<body><nav class="navbar navbar-expand-lg navbar-dark bg-dark">
<a class=navbar-brand href=/>
<img src=/site-logo.png width=40 height=45 class="d-inline-block align-top" alt>
</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class="nav-item active">
<a class=nav-link href=/>Fossix
<span class=sr-only>(current)</span>
</a>
</li>
</ul>
<form class="form-inline my-2 my-lg-0" id=search>
<input class="form-control mr-sm-2" type=search placeholder=Search aria-label=Search id=searchString name=searchString>
<button class="btn btn-outline-success my-2 my-sm-0" type=submit name=googleSearchName value=Search>Search</button>
</form>
</div>
</nav>
<div class=container-fluid style=margin-top:25px>
<div class=row>
<div class=col-md-2>
<div class="list-group list-group-flush">
<a href=/ class="list-group-item list-group-item-action">
Home
</a>
<a href=/categories/snippets class="list-group-item list-group-item-action">
Snippets
</a>
<a href=/categories/blogs class="list-group-item list-group-item-action">
Blogs
</a>
<a href=/categories/articles class="list-group-item list-group-item-action">
Articles
</a>
<a href=/archive/ class="list-group-item list-group-item-action">
Archive
</a>
</div>
</div>
<div class=col-md-6>
<div class="row content-title">
<h1>More kernel development using qemu</h1>
</div>
<div class="alert alert-light">
<span class=badge>Posted on: 22 July, 2017</span>
<div class=float-right>
<span> By santosh</span>
</div>
</div>
<hr>
<h2 id=building-a-distro-kernel>Building a distro kernel</h2>
<p>Using a tiny busybox based initrd is fine for boot testing. But sometimes you
also need a more full fledged distribution to do more. A few usecases might be</p>
<ul>
<li>Run kernel self tests</li>
<li>Test if libraries still work fine with kernel changes</li>
<li>Benchmark a code path</li>
</ul>
<p>To achieve this we can simply boot a cross-compiled kernel with a image
installed with distro image. But that will not work, since we the <code>initrd</code>
should have the required modules to mount filesystems and other
functionalities. So our tiny <code>initrd</code> won&rsquo;t be of any help here.</p>
<pre><code class=language-console>$ qemu-system-ppc64 -M pseries -m 2048 -smp cores=2 -nodefaults \
 -nographic -serial pty -monitor stdio -drive file=ppc.img,if=virtio \
 -s -net nic,model=virtio -net user,hostfwd=tcp::2222-:22 \
 -kernel vmlinux -initrd initrd.img -append &quot;root=/dev/vda5&quot;
</code></pre>
<p>The alternative is to compile the kernel and install it from inside the qemu
instance itself. If you had read the
previous
<a href=http://www.fossix.org/articles/powerpc-kernel-development-on-qemu/>article</a>,
we had compiled busybox, which took more than twice the time it took for
buiding on a native machine. So how do we tackle this issue? It&rsquo;s again just to
do with cross-compiling and installation. This time we would cross compile in
the host machine with the distro config, and do <code>make install</code> in the guest
machine.</p>
<p>How is this possible?</p>
<p>NFS to the rescue. The usual NFS setup is done on the host, mounted on the
guest. Now we can work on the kernel from two different machines, based on what
we need.</p>
<h2 id=nfs-setup>NFS Setup</h2>
<p>On host:</p>
<pre><code class=language-console>$ sudo echo &quot;/path/to/kernel/source  *(rw,sync,no_root_squash,insecure) &gt;&gt; /etc/exports
$ sudo systemctl restart nfs
</code></pre>
<p>On guest:</p>
<pre><code class=language-console>$ showmount -e 10.0.2.2 # host ip address
$ mount 10.0.2.2:/path/to/kernel/source /local-mount
</code></pre>
<p><strong>Remember to stop nfs on host when done</strong>, since we are allowing all machines to
access the mount point. To restrict to a particular machine (the guest), give
its IP address in place of <code>*</code> in <code>/etc/exports</code>.</p>
<p>Now, we can configure the kernel with the distro&rsquo;s config.</p>
<h2 id=compiling-and-installing-the-kernel>Compiling and installing the kernel</h2>
<pre><code class=language-console>$ # on the guest
$ make oldconfig
</code></pre>
<p>We can also continue with compiling the kernel, but it will be terribly slow. So
we start cross compiling in the host.</p>
<pre><code class=language-console>$ # on the host
$ cd /path/to/kernel/source
$ export ARCH=powerpc
$ export CROSS_COMPILE=powerpc64-linux-gnu-
$ make -j4
</code></pre>
<p>We can also do the kernel and modules installation from the host. For this, we
need to mount the guest filesystem in the host. This depends on the type of disk
image we used, and whether we have separate partitions for each.</p>
<p>This can be found with help of two commands, <code>fdisk</code> and <code>file</code>. The following
are from my setup of how I have the images.</p>
<pre><code class=language-console>$ # On host
$ file ppc.img
ppc.img: DOS/MBR boot sector; partition 1 : ID=0x41, active, start-CHS (0x4,4,1), end-CHS (0x14,19,2), startsector 2048, 8192 sectors; partition 2 : ID=0x83, start-CHS (0x14,20,1), end-CHS (0x3ff,254,2), startsector 10240, 2097152 sectors; partition 3 : ID=0x82, start-CHS (0x3ff,254,2), end-CHS (0x3ff,254,2), startsector 2107392, 4388864 sectors; partition 4 : ID=0x5, start-CHS (0x3ff,254,2), end-CHS (0x3ff,254,2), startsector 6496256, 77389824 sectors
$ fdisk -l ppc.img
Disk ppc.img: 40 GiB, 42949672960 bytes, 83886080 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x100065c2

Device     Boot   Start      End  Sectors  Size Id Type
ppc.img1   *       2048    10239     8192    4M 41 PPC PReP Boot
ppc.img2          10240  2107391  2097152    1G 83 Linux
ppc.img3        2107392  6496255  4388864  2.1G 82 Linux swap / Solaris
ppc.img4        6496256 83886079 77389824 36.9G  5 Extended
ppc.img5        6498304 37955583 31457280   15G 83 Linux
</code></pre>
<p>Using this information, we can mount the boot partition. From the above commands
we can see two important information, one is the sector size (512 bytes, which
is standard size in the linux kernel so far). The other is the sector start of
the boot partition (ppc.img2, 10240). How do you know this is boot? Use <code>df -h</code>
in the guest to find out which is the <code>/boot</code> partition.</p>
<p>We will use the <code>offset</code> option to mount to specify the <code>/boot</code> partition. In
this case, the start sector is 10240, so the byte offset will be 5242880
(10240 * 512).</p>
<pre><code class=language-console>$ mount -o loop,offset=5242880 ppc.img guest-boot
$ mount -o loop,offset=3327131648 ppc.img guest-root
</code></pre>
<p>Once we have successfully mounted the partition, use the <code>INSTALL_PATH</code> and
<code>INSTALL_MOD_PATH</code> environment variables to install the kernel and the modules
in the right place.</p>
<pre><code class=language-console>$ export INSTALL_PATH=/path/to/guest-boot
$ export INSTALL_MOD_PATH=/path/to/guest-root
$ make modules_install
$ make install
</code></pre>
<p>But now, we have one last problem, the installation won&rsquo;t create the <code>initramfs</code>
for the guest, only the kernel image will be copied to the partition. So, we
will have to create the <code>initramfs</code> for the new kernel, edit the grub config
file etc.</p>
<p>So we will create the <code>initramfs</code> from the guest.</p>
<pre><code class=language-console>$ # guest
$ mkinitrd /boot/initramfs-&lt;kernel-version&gt;.img &lt;kernel-version&gt;
$ grub2-mkconfig -o /boot/grub2/grub.cfg
</code></pre>
<p>Now we can either boot directly as usual, or give the kernel and initramfs in
the command line.</p>
<pre><code class=language-console>$ qemu-system-ppc64 -M pseries -m 2048 -smp cores=2 -nodefaults -nographic \
 -serial pty -monitor stdio -drive file=ppc.img,if=virtio -s \
 -net nic,model=virtio -net user,hostfwd=tcp::2222-:22 -kernel vmlinux \
 -initrd initramfs-&lt;kernel-version&gt;.img -append &quot;root=/dev/vda5&quot;
</code></pre>
<p>In the above command, while specifying the boot arguments, <code>root=/dev/vda4</code>
should be replaced by where ever your rootfs resides in the disk image.</p>
<p>Moving forward, we can edit source and cross compile on the host, boot and do
some advanced tests on the guest.</p>
<hr>
<div class=float-right>
<a href=https://fossix.org/tagskernel class="badge badge-dark">kernel</a>
<a href=https://fossix.org/tagsboot class="badge badge-dark">boot</a>
<a href=https://fossix.org/tagsfedora class="badge badge-dark">fedora</a>
<a href=https://fossix.org/tagspowerpc class="badge badge-dark">powerpc</a>
<a href=https://fossix.org/tagslinux class="badge badge-dark">linux</a>
<a href=https://fossix.org/tagsnfs class="badge badge-dark">nfs</a>
<a href=https://fossix.org/tagscompilation class="badge badge-dark">compilation</a>
</div>
</div><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<script src=/fossix.js></script>
<script src=//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<hr>
<div class=container>
<div class=row>
<div class=mx-auto>
<ul class=nav>
<li class=nav-item>
<a class="nav-link text-muted" href=/about>About</a>
</li>
<li class=nav-item>
<a class="nav-link text-muted" href=/contact/>Contact</a>
</li>
<li class=nav-item>
<a class="nav-link text-muted" href=/privacy/>Privacy Policy</a>
</li>
</ul>
</div>
</div>
<div class=row>
<div class=mx-auto>
<p>Site design and logo and content &copy; fossix.org</p>
</div>
</div>
</div>
</div>
</div>
</body>
</html>