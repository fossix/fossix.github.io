<!doctype html><html><head>
<link rel=stylesheet href=/syntax.css>
<link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css integrity=sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO crossorigin=anonymous>
<link href=/fossix.css rel=stylesheet media=screen>
<title>
Fossix - More kernel development using qemu
</title>
<script data-ad-client=ca-pub-0086577717613608 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8>
</head>
<body><nav class="navbar navbar-expand-lg navbar-dark bg-dark">
<a class=navbar-brand href=/>
<img src=/site-logo.png width=40 height=45 class="d-inline-block align-top" alt>
</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class="nav-item active">
<a class=nav-link href=/>Fossix
<span class=sr-only>(current)</span>
</a>
</li>
</ul>
<form class="form-inline my-2 my-lg-0" id=search>
<input class="form-control mr-sm-2" type=search placeholder=Search aria-label=Search id=searchString name=searchString>
<button class="btn btn-outline-success my-2 my-sm-0" type=submit name=googleSearchName value=Search>Search</button>
</form>
</div>
</nav>
<div class=container-fluid style=margin-top:25px>
<div class=row>
<div class=col-md-2>
<div class="list-group list-group-flush">
<a href=/ class="list-group-item list-group-item-action">
Home
</a>
<a href=/categories/snippets class="list-group-item list-group-item-action">
Snippets
</a>
<a href=/categories/blogs class="list-group-item list-group-item-action">
Blogs
</a>
<a href=/categories/articles class="list-group-item list-group-item-action">
Articles
</a>
<a href=/archive/ class="list-group-item list-group-item-action">
Archive
</a>
</div>
</div>
<div class=col-md-6>
<div class="row content-title">
<h1>More kernel development using qemu</h1>
</div>
<div class="alert alert-light">
<span class=badge>Posted on: 22 July, 2017</span>
<div class=float-right>
<span> By santosh</span>
</div>
</div>
<hr>
<h2 id=building-a-distro-kernel>Building a distro kernel</h2>
<p>Using a tiny busybox based initrd is fine for boot testing. But sometimes you
also need a more full fledged distribution to do more. A few usecases might be</p>
<ul>
<li>Run kernel self tests</li>
<li>Test if libraries still work fine with kernel changes</li>
<li>Benchmark a code path</li>
</ul>
<p>To achieve this we can simply boot a cross-compiled kernel with a image
installed with distro image. But that will not work, since we the <code>initrd</code>
should have the required modules to mount filesystems and other
functionalities. So our tiny <code>initrd</code> won&rsquo;t be of any help here.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>0
</span><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span>qemu-system-ppc64 -M pseries -m <span class=m>2048</span> -smp <span class=nv>cores</span><span class=o>=</span><span class=m>2</span> -nodefaults <span class=se>\
</span><span class=se></span><span class=go> -nographic -serial pty -monitor stdio -drive file=ppc.img,if=virtio \
</span><span class=go> -s -net nic,model=virtio -net user,hostfwd=tcp::2222-:22 \
</span><span class=go> -kernel vmlinux -initrd initrd.img -append &#34;root=/dev/vda5&#34;
</span></code></pre></td></tr></table>
</div>
</div><p>The alternative is to compile the kernel and install it from inside the qemu
instance itself. If you had read the
previous
<a href=http://www.fossix.org/articles/powerpc-kernel-development-on-qemu/>article</a>,
we had compiled busybox, which took more than twice the time it took for
buiding on a native machine. So how do we tackle this issue? It&rsquo;s again just to
do with cross-compiling and installation. This time we would cross compile in
the host machine with the distro config, and do <code>make install</code> in the guest
machine.</p>
<p>How is this possible?</p>
<p>NFS to the rescue. The usual NFS setup is done on the host, mounted on the
guest. Now we can work on the kernel from two different machines, based on what
we need.</p>
<h2 id=nfs-setup>NFS Setup</h2>
<p>On host:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>0
</span><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span>sudo <span class=nb>echo</span> <span class=s2>&#34;/path/to/kernel/source  *(rw,sync,no_root_squash,insecure) &gt;&gt; /etc/exports
</span><span class=s2></span><span class=gp>$ </span>sudo systemctl restart nfs
</code></pre></td></tr></table>
</div>
</div><p>On guest:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>0
</span><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span>showmount -e 10.0.2.2 <span class=c1># host ip address</span>
<span class=gp>$ </span>mount 10.0.2.2:/path/to/kernel/source /local-mount
</code></pre></td></tr></table>
</div>
</div><p><strong>Remember to stop nfs on host when done</strong>, since we are allowing all machines to
access the mount point. To restrict to a particular machine (the guest), give
its IP address in place of <code>*</code> in <code>/etc/exports</code>.</p>
<p>Now, we can configure the kernel with the distro&rsquo;s config.</p>
<h2 id=compiling-and-installing-the-kernel>Compiling and installing the kernel</h2>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>0
</span><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span><span class=c1># on the guest</span>
<span class=gp>$ </span>make oldconfig
</code></pre></td></tr></table>
</div>
</div><p>We can also continue with compiling the kernel, but it will be terribly slow. So
we start cross compiling in the host.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>0
</span><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span><span class=c1># on the host</span>
<span class=gp>$ </span><span class=nb>cd</span> /path/to/kernel/source
<span class=gp>$ </span><span class=nb>export</span> <span class=nv>ARCH</span><span class=o>=</span>powerpc
<span class=gp>$ </span><span class=nb>export</span> <span class=nv>CROSS_COMPILE</span><span class=o>=</span>powerpc64-linux-gnu-
<span class=gp>$ </span>make -j4
</code></pre></td></tr></table>
</div>
</div><p>We can also do the kernel and modules installation from the host. For this, we
need to mount the guest filesystem in the host. This depends on the type of disk
image we used, and whether we have separate partitions for each.</p>
<p>This can be found with help of two commands, <code>fdisk</code> and <code>file</code>. The following
are from my setup of how I have the images.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 0
</span><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span><span class=c1># On host</span>
<span class=gp>$ </span>file ppc.img
<span class=go>ppc.img: DOS/MBR boot sector; partition 1 : ID=0x41, active, start-CHS (0x4,4,1), end-CHS (0x14,19,2), startsector 2048, 8192 sectors; partition 2 : ID=0x83, start-CHS (0x14,20,1), end-CHS (0x3ff,254,2), startsector 10240, 2097152 sectors; partition 3 : ID=0x82, start-CHS (0x3ff,254,2), end-CHS (0x3ff,254,2), startsector 2107392, 4388864 sectors; partition 4 : ID=0x5, start-CHS (0x3ff,254,2), end-CHS (0x3ff,254,2), startsector 6496256, 77389824 sectors
</span><span class=go></span><span class=gp>$ </span>fdisk -l ppc.img
<span class=go>Disk ppc.img: 40 GiB, 42949672960 bytes, 83886080 sectors
</span><span class=go>Units: sectors of 1 * 512 = 512 bytes
</span><span class=go>Sector size (logical/physical): 512 bytes / 512 bytes
</span><span class=go>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span><span class=go>Disklabel type: dos
</span><span class=go>Disk identifier: 0x100065c2
</span><span class=go></span><span class=err>
</span><span class=err></span><span class=go>Device     Boot   Start      End  Sectors  Size Id Type
</span><span class=go>ppc.img1   *       2048    10239     8192    4M 41 PPC PReP Boot
</span><span class=go>ppc.img2          10240  2107391  2097152    1G 83 Linux
</span><span class=go>ppc.img3        2107392  6496255  4388864  2.1G 82 Linux swap / Solaris
</span><span class=go>ppc.img4        6496256 83886079 77389824 36.9G  5 Extended
</span><span class=go>ppc.img5        6498304 37955583 31457280   15G 83 Linux
</span></code></pre></td></tr></table>
</div>
</div><p>Using this information, we can mount the boot partition. From the above commands
we can see two important information, one is the sector size (512 bytes, which
is standard size in the linux kernel so far). The other is the sector start of
the boot partition (ppc.img2, 10240). How do you know this is boot? Use <code>df -h</code>
in the guest to find out which is the <code>/boot</code> partition.</p>
<p>We will use the <code>offset</code> option to mount to specify the <code>/boot</code> partition. In
this case, the start sector is 10240, so the byte offset will be 5242880
(10240 * 512).</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>0
</span><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span>mount -o loop,offset<span class=o>=</span><span class=m>5242880</span> ppc.img guest-boot
<span class=gp>$ </span>mount -o loop,offset<span class=o>=</span><span class=m>3327131648</span> ppc.img guest-root
</code></pre></td></tr></table>
</div>
</div><p>Once we have successfully mounted the partition, use the <code>INSTALL_PATH</code> and
<code>INSTALL_MOD_PATH</code> environment variables to install the kernel and the modules
in the right place.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>0
</span><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span><span class=nb>export</span> <span class=nv>INSTALL_PATH</span><span class=o>=</span>/path/to/guest-boot
<span class=gp>$ </span><span class=nb>export</span> <span class=nv>INSTALL_MOD_PATH</span><span class=o>=</span>/path/to/guest-root
<span class=gp>$ </span>make modules_install
<span class=gp>$ </span>make install
</code></pre></td></tr></table>
</div>
</div><p>But now, we have one last problem, the installation won&rsquo;t create the <code>initramfs</code>
for the guest, only the kernel image will be copied to the partition. So, we
will have to create the <code>initramfs</code> for the new kernel, edit the grub config
file etc.</p>
<p>So we will create the <code>initramfs</code> from the guest.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>0
</span><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span><span class=c1># guest</span>
<span class=gp>$ </span>mkinitrd /boot/initramfs-&lt;kernel-version&gt;.img &lt;kernel-version&gt;
<span class=gp>$ </span>grub2-mkconfig -o /boot/grub2/grub.cfg
</code></pre></td></tr></table>
</div>
</div><p>Now we can either boot directly as usual, or give the kernel and initramfs in
the command line.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>0
</span><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span>qemu-system-ppc64 -M pseries -m <span class=m>2048</span> -smp <span class=nv>cores</span><span class=o>=</span><span class=m>2</span> -nodefaults -nographic <span class=se>\
</span><span class=se></span><span class=go> -serial pty -monitor stdio -drive file=ppc.img,if=virtio -s \
</span><span class=go> -net nic,model=virtio -net user,hostfwd=tcp::2222-:22 -kernel vmlinux \
</span><span class=go> -initrd initramfs-&lt;kernel-version&gt;.img -append &#34;root=/dev/vda5&#34;
</span></code></pre></td></tr></table>
</div>
</div><p>In the above command, while specifying the boot arguments, <code>root=/dev/vda4</code>
should be replaced by where ever your rootfs resides in the disk image.</p>
<p>Moving forward, we can edit source and cross compile on the host, boot and do
some advanced tests on the guest.</p>
<hr>
<div class=float-right>
<a href=https://fossix.org/tagskernel class="badge badge-dark">kernel</a>
<a href=https://fossix.org/tagsboot class="badge badge-dark">boot</a>
<a href=https://fossix.org/tagsfedora class="badge badge-dark">fedora</a>
<a href=https://fossix.org/tagspowerpc class="badge badge-dark">powerpc</a>
<a href=https://fossix.org/tagslinux class="badge badge-dark">linux</a>
<a href=https://fossix.org/tagsnfs class="badge badge-dark">nfs</a>
<a href=https://fossix.org/tagscompilation class="badge badge-dark">compilation</a>
</div>
</div><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<script src=/fossix.js></script>
<script src=//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<hr>
<div class=container>
<div class=row>
<div class=mx-auto>
<ul class=nav>
<li class=nav-item>
<a class="nav-link text-muted" href=/about>About</a>
</li>
<li class=nav-item>
<a class="nav-link text-muted" href=/contact/>Contact</a>
</li>
<li class=nav-item>
<a class="nav-link text-muted" href=/privacy/>Privacy Policy</a>
</li>
</ul>
</div>
</div>
<div class=row>
<div class=mx-auto>
<p>Site design and logo and content &copy; fossix.org</p>
</div>
</div>
</div>
</div>
</div>
</body>
</html>